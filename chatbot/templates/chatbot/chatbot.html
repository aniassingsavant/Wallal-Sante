{% load static %} {% load i18n %}
<!DOCTYPE html>

<html lang="fr" data-bs-theme="auto" class="min-vh-100">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>{% block title %}Chatbot{% endblock %}</title>
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css"
    />
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css"
      rel="stylesheet"
    />
    <link
      rel="shortcut icon"
      href="{% static 'images/logo.png' %}"
      type="image/x-icon"
    />

    <link href="https://unpkg.com/aos@2.3.4/dist/aos.css" rel="stylesheet" />

    <link
      rel="shortcut icon"
      href="{% static 'images/logo.png' %}"
      type="image/x-icon"
    />
    <link rel="stylesheet" href="{% static 'css/bootstrap.min.css' %}" />
    <link rel="stylesheet" href="{% static 'css/carousel.css' %}" />
    <link rel="stylesheet" href="{% static 'css/cover.css' %}" />

    <!-- Swiper CDN -->
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/swiper@11/swiper-bundle.min.css"
    />
    <link rel="stylesheet" href="{% static 'css/style.css' %}" />

    <!-- Animate.css pour des effets suppl√©mentaires -->
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css"
    />
    <style>
      :root {
        --green: #2e8b57;
        --orange: #f4a261;
        --sky: #4ea8de;
        --sand: #faebd7;
        --dark: #333333;
        --rounded: 14px;
      }
      body {
        font-family: "Poppins", system-ui, -apple-system, "Segoe UI", Roboto,
          "Helvetica Neue", Arial;
        background: linear-gradient(180deg, #ffffff 0%, #faf8f6 100%);
        color: var(--dark);
        -webkit-font-smoothing: antialiased;
        -moz-osx-font-smoothing: grayscale;
        height: 100vh;
      }

      /* Container */
      .chat-wrapper {
        max-width: 1100px;
        margin: 28px auto;
        height: 88vh;
        display: flex;
        gap: 20px;
        align-items: stretch;
      }

      /* Sidebar */
      .sidebar {
        width: 260px;
        background: #fff;
        border-radius: 16px;
        padding: 16px;
        box-shadow: 0 6px 18px rgba(46, 139, 87, 0.06);
        display: flex;
        flex-direction: column;
        gap: 12px;
      }
      .brand {
        display: flex;
        align-items: center;
        gap: 10px;
      }
      .brand .logo {
        width: 44px;
        height: 44px;
        border-radius: 10px;
        background: var(--green);
        display: flex;
        align-items: center;
        justify-content: center;
        color: #fff;
        font-weight: 700;
        font-size: 20px;
      }
      .convo-list {
        flex: 1;
        overflow: auto;
        padding-right: 4px;
      }
      .convo-item {
        padding: 10px;
        border-radius: 10px;
        display: flex;
        gap: 10px;
        align-items: center;
        cursor: pointer;
      }
      .convo-item:hover {
        background: #fbf9f8;
      }

      /* Chat area */
      .chat-area {
        flex: 1;
        background: #fff;
        border-radius: 16px;
        padding: 18px;
        display: flex;
        flex-direction: column;
        box-shadow: 0 8px 28px rgba(0, 0, 0, 0.06);
      }
      .chat-header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        border-bottom: 1px solid #f2f2f2;
        padding-bottom: 12px;
      }
      .chat-messages {
        flex: 1;
        overflow: auto;
        padding: 18px 8px;
        display: flex;
        flex-direction: column;
        gap: 12px;
      }

      /* bubbles */
      .bubble {
        max-width: 78%;
        padding: 12px 14px;
        border-radius: 14px;
        line-height: 1.25;
      }
      .bubble.bot {
        background: linear-gradient(180deg, var(--sand), #fff);
        border: 1px solid rgba(46, 139, 87, 0.06);
        align-self: flex-start;
        border-bottom-left-radius: 6px;
      }
      .bubble.user {
        background: var(--green);
        color: white;
        align-self: flex-end;
        border-bottom-right-radius: 6px;
      }
      .meta {
        font-size: 11px;
        color: #666;
        margin-top: 6px;
      }

      /* input area */
      .composer {
        display: flex;
        gap: 8px;
        padding-top: 12px;
        align-items: center;
      }
      .composer .form-control {
        border-radius: 12px;
        padding: 12px 14px;
      }
      .btn-send {
        background: var(--green);
        color: white;
        border-radius: 12px;
        padding: 10px 16px;
        border: none;
      }
      .btn-send:disabled {
        opacity: 0.6;
      }

      /* small screens */
      @media (max-width: 900px) {
        .sidebar {
          display: none;
        }
        .chat-wrapper {
          margin: 12px;
          height: 94vh;
        }
      }
      <style>
  /* Zone d‚Äôaffichage pour le code IA */
  pre.code-block {
        background: #1e1e1e;
        color: #f8f8f2;
        padding: 12px 16px;
        border-radius: 12px;
        overflow-x: auto;
        font-family: "Fira Code", monospace;
        font-size: 14px;
        line-height: 1.5;
        white-space: pre-wrap;
        word-break: break-word;
      }

      /* On garde de la place en bas pour la zone d‚Äôentr√©e */
      .chat-messages {
        flex: 1;
        overflow-y: auto;
        padding-bottom: 100px; /* espace r√©serv√© pour le champ message/audio */
      }

      /* Zone d‚Äôentr√©e bien visible et fix√©e en bas */
      .composer {
        display: flex;
        gap: 8px;
        align-items: center;
        padding: 12px;
        background: #fff;
        position: sticky;
        bottom: 0;
        left: 0;
        border-top: 1px solid #ddd;
      }

      /* Champ texte √©tendu */
      .composer .form-control {
        flex: 1;
        border-radius: 12px;
        padding: 12px 14px;
      }

      /* Bouton micro */
      .btn-audio {
        background: var(--orange);
        color: white;
        border: none;
        border-radius: 12px;
        padding: 10px 14px;
      }
    </style>
  </head>

  <body class="h-100 py-0">
    <header class="">
      <nav class="navbar navbar-expand-lg bg-body-tertiary fixed-top">
        <div class="container-fluid">
          <button
            class="navbar-toggler"
            type="button"
            data-bs-toggle="collapse"
            data-bs-target="#navbarsExample11"
            aria-controls="navbarsExample11"
            aria-expanded="false"
            aria-label="Toggle navigation"
          >
            <span class="navbar-toggler-icon"></span>
          </button>

          <div
            class="collapse navbar-collapse d-lg-flex justify-content-center"
            id="navbarsExample11"
          >
            <div
              class="navbar-brand d-flex align-items-center col-lg-2 me-0 py-0"
            >
              <img
                src="{% static 'images/logo.png' %}"
                width="50"
                height="50"
                alt="logo"
                class="rounded-2"
              />
              <span class="brand-text ms-2">
                <span class="brand-withe">WALLAL</span>
                <span class="brand-orange"> SANTE</span>
              </span>
            </div>

            <ul
              class="navbar-nav col-lg-7 justify-content-lg-center gap-4 mt-2"
            >
              <li class="nav-item">
                <a class="nav-link fw-bold py-1 px-0" href="{% url 'accueil' %}"
                  >Accueil</a
                >
              </li>
              <li class="nav-item">
                <a class="nav-link fw-bold py-1 px-0" href="#conseils"
                  >Conseils</a
                >
              </li>
              <li class="nav-item">
                <a class="nav-link fw-bold py-1 px-0" href="#about">√Ä propos</a>
              </li>
              <li class="nav-item">
                <a class="nav-link fw-bold py-1 px-0" href="#actualite"
                  >Actualit√©</a
                >
              </li>
            </ul>

            <div class="d-lg-flex col-lg-3 justify-content-lg-end gap-2">
              {% if not user.is_authenticated %}
              <a href="{% url 'inscription' %}" class="btn btn-outline-primary"
                >S'inscrire</a
              >
              <a href="{% url 'connexion' %}" class="btn btn-outline-primary"
                >Se connecter</a
              >
              {% else %}
              <a href="{% url 'deconnexion' %}" class="btn btn-outline-primary"
                >Se d√©connecter</a
              >
              {% endif %}
            </div>
          </div>
        </div>
      </nav>
    </header>

    <nav
      class="navbar navbar-expand-lg bg-body-tertiary bg-opacity-100 pb-0 mb-0 fixed-top"
    >
      <div class="container-fluid">
        <button
          class="navbar-toggler"
          type="button"
          data-bs-toggle="collapse"
          data-bs-target="#navbarsExample11"
          aria-controls="navbarsExample11"
          aria-expanded="false"
          aria-label="Toggle navigation"
        >
          <span class="navbar-toggler-icon"></span>
        </button>
        <div
          class="collapse navbar-collapse d-lg-flex justify-content-center"
          id="navbarsExample11"
        >
          <div
            class="navbar-brand d-flex align-items-center col-lg-2 me-0 py-0"
          >
            <img
              class="float-md-start mb-0 rounded-2 md-2"
              src="{% static 'images/logo.png' %}"
              width="50"
              height="50"
              alt="logo"
            />
            <span class="brand-text">
              <span class="brand-withe"> WALLAL </span>
              <span class="brand-orange"> SANTE </span>
            </span>
            <p>&nbsp;&nbsp;</p>
            <h5 class="h5 brand animate__animated" id="navbar-typed">&nbsp;</h5>
          </div>

          <ul
            class="float-md-end mt-2 gap-4 navbar-nav col-lg-7 justify-content-lg-center"
          >
            <li class="nav-item">
              <a
                class="nav-link fw-bold py-1 px-0 active"
                aria-current="page"
                href="{% url 'accueil' %}"
                >Accueil</a
              >
            </li>

            <li class="nav-item">
              <a class="nav-link fw-bold py-1 px-0" href="">Actualit√©</a>
            </li>
            <li class="nav-item">
              {% if not user.is_authenticated %} {% endif %}
            </li>
          </ul>
          <div class="d-lg-flex col-lg-3 justify-content-lg-end">
            {% if not user.is_authenticated %}
            <p class="btn bg-outline-primary">
              <a href="{%url 'inscription'%}" class="link-light">S'inscrire</a>
            </p>
            <p class="text-gdd">|</p>
            <p class="btn bg-outline-primary">
              <a href="{% url 'connexion'%}" class="link-light">Se connecter</a>
            </p>
            {% else %}
            <p class="btn bg-outline-primary">
              <a href="{% url 'deconnexion' %}" class="link-light"
                >Se d√©connecter</a
              >
            </p>
            {% endif %}
          </div>
        </div>
      </div>
    </nav>

    <script>
      document.addEventListener("DOMContentLoaded", function () {
        const links = document.querySelectorAll(".nav-link");
        const path = window.location.pathname;

        links.forEach((link) => {
          if (link.getAttribute("href") === path) {
            link.classList.add("active");
          } else {
            link.classList.remove("active");
          }
        });
      });
    </script>

    {% block content %} {% if user.is_authenticated %}
    <a href="">Se d√©connecter</a>
    {% else %}
    <a href=" {%url 'connexion'%}">Se connecter</a>
    <a href="{%url 'inscription'%}">S'inscrire</a>
    {% endif %} {% endblock %}

    <div class="chat-wrapper px-3">
      <!-- Sidebar -->
      <aside class="sidebar" aria-label="Navigation conversation">
        <div class="brand">
          <div>
            <div style="font-size: 12px; color: #666">
              Assistant sant√© ‚Äî Votre compagnon
            </div>
          </div>
        </div>

        <div class="d-flex gap-2 align-items-center mt-2">
          <button id="startBtn" class="btn btn-outline-secondary btn-sm w-100">
            Nouvelle conversation
          </button>
        </div>

        <div class="convo-list mt-2" id="convoList" role="list">
          <!-- exemple -->
          <div class="convo-item" role="listitem" tabindex="0">
            <div
              style="
                width: 44px;
                height: 44px;
                border-radius: 8px;
                background: var(--sand);
                display: flex;
                align-items: center;
                justify-content: center;
              "
            ></div>
            <div style="flex: 1">
              <div style="font-weight: 600">Assistant</div>
              <div style="font-size: 12px; color: #666">
                Conseils de pr√©vention
              </div>
            </div>
          </div>
        </div>

        <div style="font-size: 12px; color: #666">Langue</div>
        <div class="d-flex gap-2">
          <button class="btn btn-sm btn-outline-primary" id="langFr">
            Fran√ßais
          </button>
          <button
            class="btn btn-sm"
            id="langFul"
            style="background: var(--orange); color: #fff"
          >
            Fulfulde
          </button>
        </div>

        <div style="font-size: 12px; color: #666; margin-top: 12px">
          Centres proches
        </div>
        <div style="font-size: 13px; color: var(--dark); font-weight: 600">
          0 trouv√©s ‚Äî actif en mode d√©mo
        </div>
      </aside>

      <!-- Chat principale -->
      <main class="chat-area" role="main">
        <div class="chat-header">
          <div>
            <div style="font-weight: 700; font-size: 18px">
              Assistant Wallal Sant√©
            </div>
            <div style="font-size: 13px; color: #666">
              Posez vos questions de sant√© ‚Äî r√©ponses en fran√ßais et Fulfulde
            </div>
          </div>
          <div class="d-flex align-items-center gap-2">
            <button
              class="btn btn-sm"
              title="Activer la lecture vocale"
              id="ttsBtn"
            >
              üîä
            </button>
            <button class="btn btn-sm btn-outline-secondary" id="helpBtn">
              Aide
            </button>
          </div>
        </div>

        <div
          class="chat-messages"
          id="messages"
          aria-live="polite"
          aria-atomic="false"
        >
          <!-- messages dynamiques -->
          <div class="bubble bot" data-role="bot">
            Bonjour üëã, je suis Wallal, votre assistant sant√©. Comment puis-je
            vous aider aujourd'hui ?
            <div class="meta">Assistant ‚Ä¢ maintenant</div>
          </div>
        </div>

        <form
          id="composer"
          class="composer"
          onsubmit="return false;"
          aria-label="Envoyer un message"
        >
          <input
            id="messageInput"
            class="form-control"
            placeholder="√âcrire un message ou demander 'centre le plus proche'"
            aria-label="Message"
            autocomplete="off"
          />
          <button
            type="button"
            class="btn-audio"
            id="audioBtn"
            title="Envoyer un message vocal"
          >
            <i class="fa fa-microphone"></i>
          </button>
          <button id="sendBtn" class="btn-send" type="button">Envoyer</button>
        </form>
      </main>
    </div>

    <!-- Optional: Bootstrap JS and dependencies (popper) -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>

    <script>
      // === Configuration ===
      // Remplacez par l'URL de votre endpoint Django qui renvoie la r√©ponse AI
      const API_URL = "/api/assistant/"; // <-- √† adapter

      const messagesEl = document.getElementById("messages");
      const inputEl = document.getElementById("messageInput");
      const sendBtn = document.getElementById("sendBtn");
      const startBtn = document.getElementById("startBtn");
      function appendCodeBlock(code, who = "bot") {
        const div = document.createElement("div");
        div.className = "bubble " + (who === "user" ? "user" : "bot");
        div.innerHTML =
          '<pre class="code-block">' +
          escapeHtml(code) +
          "</pre>" +
          '<div class="meta">' +
          (who === "user" ? "Vous" : "Assistant") +
          " ‚Ä¢ " +
          new Date().toLocaleTimeString() +
          "</div>";
        messagesEl.appendChild(div);
        messagesEl.scrollTop = messagesEl.scrollHeight;
      }

      function appendBubble(text, who = "bot") {
        const div = document.createElement("div");
        div.className = "bubble " + (who === "user" ? "user" : "bot");
        div.innerHTML =
          text +
          '<div class="meta">' +
          (who === "user" ? "Vous" : "Assistant") +
          " ‚Ä¢ " +
          new Date().toLocaleTimeString() +
          "</div>";
        messagesEl.appendChild(div);
        messagesEl.scrollTop = messagesEl.scrollHeight;
      }

      // Demo: envoi local + mock reply (remplacer par fetch vers votre backend)
      async function sendMessage() {
        const text = inputEl.value.trim();
        if (!text) return;
        appendBubble(escapeHtml(text), "user");
        inputEl.value = "";
        sendBtn.disabled = true;

        // Afficher un loader de r√©ponse
        const loader = document.createElement("div");
        loader.className = "bubble bot";
        loader.id = "loader";
        loader.innerHTML = "G√©n√©ration de la r√©ponse...";
        messagesEl.appendChild(loader);
        messagesEl.scrollTop = messagesEl.scrollHeight;

        try {
          // Exemple: simulation d'appel r√©seau
          await new Promise((r) => setTimeout(r, 900));

          // TODO: si vous avez un endpoint Django, remplacez la partie ci-dessous par un fetch POST
          // const resp = await fetch(API_URL, {method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({message:text, lang:'fr'})});
          // const data = await resp.json();
          // const reply = data.reply || 'D√©sol√©, je n\'ai pas de r√©ponse.';

          // Mock reply basique
          const reply = mockReply(text);

          const loaderEl = document.getElementById("loader");
          if (loaderEl) loaderEl.remove();
          appendBubble(escapeHtml(reply), "bot");
        } catch (err) {
          const loaderEl = document.getElementById("loader");
          if (loaderEl) loaderEl.remove();
          appendBubble("Erreur r√©seau ‚Äî v√©rifiez votre connexion.", "bot");
        } finally {
          sendBtn.disabled = false;
        }
      }

      sendBtn.addEventListener("click", sendMessage);
      inputEl.addEventListener("keydown", (e) => {
        if (e.key === "Enter" && !e.shiftKey) {
          e.preventDefault();
          sendMessage();
        }
      });
      startBtn.addEventListener("click", () => {
        messagesEl.innerHTML = "";
        appendBubble(
          "Bonjour üëã, je suis Wallal, votre assistant sant√©. Comment puis-je vous aider aujourd'hui ?",
          "bot"
        );
      });

      function escapeHtml(unsafe) {
        return unsafe
          .replaceAll("&", "&amp;")
          .replaceAll("<", "&lt;")
          .replaceAll(">", "&gt;")
          .replaceAll('"', "&quot;")
          .replaceAll("'", "&#039;");
      }

      function mockReply(text) {
        const t = text.toLowerCase();
        if (
          t.includes("centre") ||
          t.includes("h√¥pital") ||
          t.includes("hopital") ||
          t.includes("proche")
        ) {
          return "Je peux vous aider √† trouver le centre de sant√© le plus proche. Autorisez l'acc√®s √† la localisation ou entrez votre localit√©.";
        }
        if (t.includes("fi√®vre") || t.includes("paludisme")) {
          return "Les sympt√¥mes de paludisme incluent fi√®vre, frissons et maux de t√™te. Si vous avez de la fi√®vre, consultez un centre de sant√© rapidement.";
        }
        return "Merci pour votre question. Pouvez-vous pr√©ciser votre √¢ge, votre r√©gion, et depuis quand vous avez ces sympt√¥mes ?";
      }
    </script>
    <script src="https://unpkg.com/aos@2.3.4/dist/aos.js"></script>
    <script>
      // Transition douce entre les pages
      document.addEventListener("DOMContentLoaded", function () {
        document.body.classList.add("page-loaded");
        AOS.init({
          duration: 900,
          once: false,
          easing: "ease-in-out",
          mirror: true,
        });
      });
    </script>
    <script>
      // S√©lecteur de th√®me simple
      const themeToggle = document.getElementById("themeToggle");
      const themeIcon = document.getElementById("themeIcon");
      const html = document.documentElement;

      // R√©cup√©rer le th√®me sauvegard√©
      const savedTheme = localStorage.getItem("theme") || "light";
      html.setAttribute("data-bs-theme", savedTheme);
      updateIcon(savedTheme);

      // Changer de th√®me au clic
      themeToggle.addEventListener("click", () => {
        const currentTheme = html.getAttribute("data-bs-theme");
        const newTheme = currentTheme === "light" ? "dark" : "light";

        html.setAttribute("data-bs-theme", newTheme);
        localStorage.setItem("theme", newTheme);
        updateIcon(newTheme);
      });

      // Mettre √† jour l'ic√¥ne
      function updateIcon(theme) {
        if (theme === "dark") {
          themeIcon.className = "bi bi-moon-stars-fill";
        } else {
          themeIcon.className = "bi bi-sun-fill";
        }
      }
    </script>

    <!-- Swiper JS -->
    <script src="{% static 'js/bootstrap.bundle.min.js' %}"></script>
    <script src="{% static 'js/color-modes.js' %}"></script>
    <script src="https://cdn.jsdelivr.net/npm/swiper@11/swiper-bundle.min.js"></script>
  </body>
</html>
